# Инструкция по тестированию загрузки изображений

## Исправленные проблемы

### 1. API загрузки изображений (`/api/admin/upload`)
**Что исправлено:**
- Добавлена проверка существования директории `public` перед загрузкой
- Добавлена верификация записи файла после сохранения
- Улучшено логирование процесса загрузки
- Добавлены подробные сообщения об ошибках

### 2. Превью изображений в форме (`/admin-products-add`)
**Что исправлено:**
- Убран параметр `?t=${Date.now()}` из URL изображений (мог вызывать проблемы кэширования)
- Добавлен `loading="lazy"` для ленивой загрузки
- Улучшена обработка ошибок с подробными сообщениями
- Добавлен fallback UI при ошибке загрузки

### 3. Диагностика
**Что добавлено:**
- Новый endpoint `/api/admin/check-file` для проверки доступа к файлам
- Расширенное логирование в консоли браузера и сервера

---

## Как тестировать

### Шаг 1: Запуск сервера

```bash
npm run dev
```

### Шаг 2: Проверка директории

Убедитесь что директория существует:
```
c:\dev\poj-pro\Poj-Pro\public\ProductImages\
```

В ней уже есть файлы (они были загружены ранее).

### Шаг 3: Тестирование загрузки изображения

1. Откройте браузер и перейдите на: `http://localhost:3000/admin-products-add`
2. Введите токен администратора (по умолчанию: `admin-ship-2025`)
3. Заполните обязательные поля:
   - Slug: `test-product`
   - Название (русский): `Тестовый товар`
4. Выберите существующую категорию или создайте новую
5. **Загрузите изображение:**
   - Перетащите файл в зону загрузки или нажмите для выбора
   - Поддерживаемые форматы: JPG, PNG, WEBP, AVIF, GIF, SVG

### Шаг 4: Проверка превью

После загрузки:
- Изображение должно отобразиться в сетке превью
- Если появилась ошибка ⚠️ — откройте консоль браузера (F12) и посмотрите лог

### Шаг 5: Диагностика через API

Если изображения не загружаются, проверьте через API:

```bash
# Проверка директории и файлов
curl "http://localhost:3000/api/admin/check-file?file=test.jpg" \
  -H "x-admin-token: admin-ship-2025" | jq
```

Или откройте в браузере (с установленным расширением для заголовков):
- URL: `http://localhost:3000/api/admin/check-file`
- Header: `x-admin-token: admin-ship-2025`

**Ожидаемый ответ:**
```json
{
  "success": true,
  "data": {
    "cwd": "c:\\dev\\poj-pro\\Poj-Pro",
    "publicDir": "c:\\dev\\poj-pro\\Poj-Pro\\public",
    "uploadDir": "c:\\dev\\poj-pro\\Poj-Pro\\public\\ProductImages",
    "publicDirExists": true,
    "uploadDirExists": true,
    "recentFiles": [...],
    "totalFiles": 200
  }
}
```

### Шаг 6: Проверка сохранения товара

1. После загрузки изображений нажмите "Создать товар"
2. Проверьте консоль браузера на наличие ошибок
3. Проверьте базу данных — изображения должны сохраниться в таблице `ProductImage`

---

## Возможные проблемы и решения

### Проблема 1: "Директория public не найдена"
**Решение:** Убедитесь что запускаете сервер из корня проекта:
```bash
cd c:\dev\poj-pro\Poj-Pro
npm run dev
```

### Проблема 2: "Не удалось сохранить файл"
**Решение:** Проверьте права доступа к директории:
```powershell
# PowerShell - проверить права
icacls "c:\dev\poj-pro\Poj-Pro\public\ProductImages"
```

### Проблема 3: Изображение загрузилось, но превью не работает
**Решение:**
1. Откройте `http://localhost:3000/ProductImages/<имя_файла>` в новой вкладке
2. Если изображение не отображается — проверьте консоль сервера на ошибки
3. Если отображается — очистите кэш браузера (Ctrl+Shift+Delete)

### Проблема 4: Ошибка 404 при загрузке
**Решение:** Проверьте что сервер запущен и endpoint доступен:
```bash
curl http://localhost:3000/api/admin/upload
# Должен вернуть 401 Unauthorized (это нормально, значит endpoint работает)
```

### Проблема 5: Файл не записывается (Windows)
**Решение:** Возможно антивирус блокирует запись. Попробуйте:
1. Временно отключить антивирус
2. Запустить терминал от имени администратора
3. Проверить что нет блокировок файла

---

## Логи для отладки

### Консоль браузера (F12)
Искать сообщения:
- `[Frontend] Starting upload for files:`
- `[Frontend] Upload response:`
- `[Preview Error] Failed to load image:`

### Консоль сервера
Искать сообщения:
- `[upload] Public directory:`
- `[upload] Processing file:`
- `[upload] Writing file to:`
- `[upload] File saved successfully:`

---

## Чеклист успешного тестирования

- [ ] Директория `public/ProductImages` существует
- [ ] Сервер запущен и доступен `http://localhost:3000`
- [ ] Токен администратора принят
- [ ] Изображение загружается через форму
- [ ] Превью отображается корректно
- [ ] Товар сохраняется с изображениями
- [ ] В базе данных запись в `ProductImage` создана

---

## Контакты для помощи

Если проблема не решена:
1. Скопируйте логи из консоли браузера
2. Скопируйте логи сервера
3. Сделайте скриншот ошибки
4. Проверьте `/api/admin/check-file` и приложите ответ
